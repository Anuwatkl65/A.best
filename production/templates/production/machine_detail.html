# views.py
from django.db.models import Sum, Max
from django.db.models.functions import TruncHour

@login_required
def machine_detail(request, machine_no):
    dept = request.GET.get("department", "Preform")
    department_label = LABELS.get(dept, dept)

    # ----- 1) ดึง Lot ทั้งหมดของเครื่องนี้ -----
    lot_qs = Lot.objects.filter(machine_no__iexact=machine_no)

    # ใช้ lot ที่มีการสแกนล่าสุดเป็น "lot ปัจจุบันของเครื่อง"
    lot_qs = lot_qs.annotate(last_scan_time=Max("scans__scanned_at"))
    current_lot = lot_qs.order_by("-last_scan_time").first()

    # ถ้าเครื่องยังไม่มี lot เลย
    if not current_lot:
        ctx = {
            "department": dept,
            "department_label": department_label,
            "machine_no": machine_no,
            "current_lot": None,
            "status": "Ready",
            "produced": 0,
            "target": 0,
            "progress": 0,
            "first_scan": None,
            "last_scan": None,
            "chart_labels": "[]",
            "chart_values": "[]",
        }
        return render(request, "production/machine_detail.html", ctx)

    # ----- 2) คำนวณข้อมูลของ Lot ปัจจุบัน -----
    produced = current_lot.scans.aggregate(s=Sum("qty"))["s"] or 0
    target = current_lot.target or current_lot.production_quantity or 0

    if target > 0:
        progress = min(100, int(produced * 100 / target))
    else:
        progress = 0

    first_scan = current_lot.scans.order_by("scanned_at").first()
    last_scan = current_lot.scans.order_by("-scanned_at").first()

    # สถานะง่าย ๆ จาก progress (จะเปลี่ยน logic ภายหลังได้)
    if produced == 0:
        status = "Ready"
    elif progress >= 100:
        status = "Finished"
    else:
        status = "Running"

    # ----- 3) เตรียมข้อมูลกราฟรายชั่วโมง 24 ชม. ล่าสุด -----
    hourly_qs = (
        current_lot.scans
        .annotate(h=TruncHour("scanned_at"))
        .values("h")
        .annotate(total_qty=Sum("qty"))
        .order_by("h")
    )

    chart_labels = []
    chart_values = []
    for row in hourly_qs:
        h = row["h"]
        qty = row["total_qty"] or 0
        chart_labels.append(h.strftime("%H:%M"))
        chart_values.append(qty)

    ctx = {
        "department": dept,
        "department_label": department_label,
        "machine_no": machine_no,
        "current_lot": current_lot,
        "status": status,
        "produced": produced,
        "target": target,
        "progress": progress,
        "first_scan": first_scan.scanned_at if first_scan else None,
        "last_scan": last_scan.scanned_at if last_scan else None,
        "chart_labels": json.dumps(chart_labels),
        "chart_values": json.dumps(chart_values),
    }
    return render(request, "production/machine_detail.html", ctx)
