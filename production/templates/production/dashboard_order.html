{% extends "production/base.html" %}
{% load humanize %}

{% block title %}Dashboard: {{ department_label }} · Order View{% endblock %}

{% block content %}
<div class="page-container">

  <!-- Breadcrumb -->
  <div class="flex justify-between items-center mb-4">
    <div class="flex items-center gap-2 text-sm">
      <span class="material-symbols-outlined text-base">home</span>
      <a href="{% url 'home_menu' %}" class="text-purple-700 hover:underline">Home</a>
      <span class="text-gray-400">/</span>
      <span class="text-gray-600">Dashboard: {{ department_label }}</span>
      <span class="text-gray-400">/</span>
      <span class="text-gray-900 font-semibold">Order View</span>
    </div>

    <!-- ปุ่มสลับ layout (การ์ด/ตาราง) -->
    <div class="inline-flex gap-3">
      <a href="?department={{ department }}&view=order&layout=cards"
         class="{% if layout_mode == 'cards' %}layout-btn-active{% else %}layout-btn{% endif %}">
        แบบการ์ด
      </a>

      <a href="?department={{ department }}&view=order&layout=table"
         class="{% if layout_mode == 'table' %}layout-btn-active{% else %}layout-btn{% endif %}">
        แบบตาราง
      </a>
    </div>
  </div>

  <!-- กล่องสรุปยอดรวมแบบใหม่ -->
  <div class="card-outline mb-6">
      <div class="text-purple-500 text-sm mb-1">
        ยอดรวมเป้าผลิตในแผนก (ทุกประเภท)
      </div>

      <div class="text-5xl font-extrabold text-gray-900">
        {{ overall_total_target|default:0|intcomma }}
        <span class="text-xl font-light text-gray-500">pcs</span>
      </div>

      <!-- การ์ดแต่ละประเภท -->
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mt-6">

        <!-- ORDER -->
        <a href="?department={{ department }}&view=order&layout={{ layout_mode }}&lot_type=order"
           class="card-outline text-center p-4 hover:bg-green-50 transition">
            <div class="text-green-700 text-xs font-semibold">ORDER</div>
            <div class="text-3xl font-bold mt-1">{{ overall_qty_by_type.Order|default:0|intcomma }}</div>
            <div class="text-gray-500 text-xs mt-1">{{ type_counts.order|default:0 }} lots</div>
        </a>

        <!-- SAMPLE -->
        <a href="?department={{ department }}&view=order&layout={{ layout_mode }}&lot_type=sample"
           class="card-outline text-center p-4 hover:bg-yellow-50 transition">
            <div class="text-yellow-700 text-xs font-semibold">SAMPLE</div>
            <div class="text-3xl font-bold mt-1">{{ overall_qty_by_type.Sample|default:0|intcomma }}</div>
            <div class="text-gray-500 text-xs mt-1">{{ type_counts.sample|default:0 }} lots</div>
        </a>

        <!-- RESERVED -->
        <a href="?department={{ department }}&view=order&layout={{ layout_mode }}&lot_type=reserved"
           class="card-outline text-center p-4 hover:bg-blue-50 transition">
            <div class="text-blue-700 text-xs font-semibold">RESERVED</div>
            <div class="text-3xl font-bold mt-1">{{ overall_qty_by_type.Reserved|default:0|intcomma }}</div>
            <div class="text-gray-500 text-xs mt-1">{{ type_counts.reserved|default:0 }} lots</div>
        </a>

        <!-- EXTRA -->
        <a href="?department={{ department }}&view=order&layout={{ layout_mode }}&lot_type=extra"
           class="card-outline text-center p-4 hover:bg-orange-50 transition">
            <div class="text-orange-700 text-xs font-semibold">EXTRA</div>
            <div class="text-3xl font-bold mt-1">{{ overall_qty_by_type.Extra|default:0|intcomma }}</div>
            <div class="text-gray-500 text-xs mt-1">{{ type_counts.extra|default:0 }} lots</div>
        </a>

        <!-- CLAIM -->
        <a href="?department={{ department }}&view=order&layout={{ layout_mode }}&lot_type=claim"
           class="card-outline text-center p-4 hover:bg-rose-50 transition">
            <div class="text-rose-700 text-xs font-semibold">CLAIM</div>
            <div class="text-3xl font-bold mt-1">{{ overall_qty_by_type.Claim|default:0|intcomma }}</div>
            <div class="text-gray-500 text-xs mt-1">{{ type_counts.claim|default:0 }} lots</div>
        </a>

      </div>
  </div>

  <!-- สรุปตามเครื่อง -->
  <h2 class="text-lg font-semibold text-gray-900 mb-3">สรุปตามเครื่อง</h2>

  {% if layout_mode == "cards" %}

      {% if machine_summaries %}
          <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">

              {% for m in machine_summaries %}
              <div class="card-outline p-5">
                  
                  <div class="flex justify-between mb-3">
                      <div>
                          <div class="font-semibold">{{ m.machine_no }}</div>
                          <div class="text-gray-500 text-xs">ยอดรวมเป้าในเครื่อง</div>
                      </div>
                      <div class="text-sm text-gray-600">
                          {{ m.total_produced|intcomma }} / {{ m.total_target|intcomma }} pcs
                      </div>
                  </div>

                  <!-- Progress bar -->
                  <div class="w-full h-2 rounded-full bg-gray-200 overflow-hidden mb-3">
                      <div class="h-full bg-green-400" style="width: {{ m.progress }}%;"></div>
                  </div>
                  <div class="text-xs text-gray-500 mb-4">Progress: {{ m.progress }}%</div>

                  <!-- Breakdown -->
                  <div class="grid grid-cols-5 gap-2">
                      {% for t, info in m.types.items %}
                      <div class="text-center bg-gray-50 rounded-lg p-2 border border-gray-200">
                          <div class="text-xs font-semibold text-gray-700">{{ t }}</div>
                          <div class="text-lg font-bold">{{ info.target|intcomma }}</div>
                          <div class="text-[11px] text-gray-500">{{ info.count }} lots</div>
                      </div>
                      {% endfor %}
                  </div>

                  <div class="mt-4 text-right">
                      <a href="?department={{ department }}&view=list&machine_no={{ m.machine_no }}"
                         class="text-xs text-purple-700 hover:underline">
                          ดู Lot ในเครื่องนี้ →
                      </a>
                  </div>
              </div>
              {% endfor %}

          </div>
      {% else %}
          <div class="text-gray-400 text-sm">ยังไม่มีข้อมูลในแผนกนี้</div>
      {% endif %}

  {% else %}
      <!-- Layout = table -->
      <div class="card-outline p-4 overflow-x-auto">
          <table class="min-w-full text-sm">
              <thead>
                  <tr class="text-gray-500 border-b">
                      <th class="text-left py-2">เครื่อง</th>
                      <th class="text-right py-2">เป้ารวม</th>
                      <th class="text-right py-2">ผลิตแล้ว</th>
                      <th class="text-right py-2">Progress</th>
                      <th class="text-right py-2">จำนวน Lots</th>
                      <th></th>
                  </tr>
              </thead>
              <tbody>
                  {% for m in machine_summaries %}
                  <tr class="border-b">
                      <td class="py-2">{{ m.machine_no }}</td>
                      <td class="py-2 text-right">{{ m.total_target|intcomma }}</td>
                      <td class="py-2 text-right">{{ m.total_produced|intcomma }}</td>
                      <td class="py-2 text-right">{{ m.progress }}%</td>
                      <td class="py-2 text-right">{{ m.lots|length }} lots</td>
                      <td class="py-2 text-right">
                          <a href="?department={{ department }}&view=list&machine_no={{ m.machine_no }}"
                             class="text-xs text-purple-700 hover:underline">ดูรายละเอียด</a>
                      </td>
                  </tr>
                  {% endfor %}
              </tbody>
          </table>
      </div>

  {% endif %}

</div>

<!-- CSS ส่วนกลาง -->
<style>
.card-outline {
    border: 2px solid #cba4ff;
    border-radius: 18px;
    background: white;
    box-shadow: 0 2px 6px #00000010;
}

.layout-btn {
    background: transparent;
    color: #777;
    padding: 6px 18px;
    border-radius: 20px;
    transition: 0.2s;
}

.layout-btn:hover {
    background: #f5ecff;
    color: #7b2cff;
}

.layout-btn-active {
    background: white;
    color: #7b2cff;
    border: 2px solid #cba4ff;
    padding: 6px 18px;
    border-radius: 20px;
    box-shadow: 0 2px 6px #00000010;
}
</style>

{% endblock %}
