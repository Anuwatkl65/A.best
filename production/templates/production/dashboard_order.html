{% extends "production/base.html" %}
{% load humanize %}
{% block title %}Dashboard: {{ department_label }} · Order View{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-6">

  <!-- breadcrumb + หัวข้อ -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <nav class="text-xs text-gray-400 mb-1">
        <a href="{% url 'home_menu' %}" class="hover:text-white/90">Home</a>
        <span class="mx-1">/</span>
        <span>Dashboard: {{ department_label }}</span>
        <span class="mx-1">/</span>
        <span class="text-purple-500 font-semibold">Order View</span>
      </nav>
      <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900">
        Dashboard: {{ department_label }}
      </h1>
      <p class="text-sm text-gray-500">Order View</p>
    </div>

    <a href="{% url 'view_select' %}?department={{ department }}"
      class="inline-flex items-center gap-1 px-4 py-2 rounded-full bg-white text-gray-700 text-sm shadow hover:bg-purple-50">
      ← กลับไปเลือกแผนก
    </a>
  </div>

  <!-- SUMMARY BY TYPE -->
  <div class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-8">
    <!-- All -->
    <div class="rounded-xl bg-white p-3 shadow-sm border border-purple-300">
      <div class="text-xs text-gray-500">All Types</div>
      <div class="mt-1 flex items-end justify-between">
        <div class="text-2xl font-extrabold text-gray-900">
          {{ type_counts.all|default:0|intcomma }}
        </div>
        <span class="text-[10px] px-2 py-0.5 rounded-full bg-purple-100 text-purple-700">
          lots
        </span>
      </div>
    </div>

    <!-- Order -->
    <div class="rounded-xl bg-white p-3 shadow-sm border border-emerald-200">
      <div class="text-xs text-gray-500">Order</div>
      <div class="mt-1 flex items-end justify-between">
        <div class="text-2xl font-extrabold text-gray-900">
          {{ type_counts.order|default:0|intcomma }}
        </div>
        <span class="text-[10px] px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700">
          lots
        </span>
      </div>
    </div>

    <!-- Sample -->
    <div class="rounded-xl bg-white p-3 shadow-sm border border-yellow-200">
      <div class="text-xs text-gray-500">Sample</div>
      <div class="mt-1 flex items-end justify-between">
        <div class="text-2xl font-extrabold text-gray-900">
          {{ type_counts.sample|default:0|intcomma }}
        </div>
        <span class="text-[10px] px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-700">
          lots
        </span>
      </div>
    </div>

    <!-- Reserved -->
    <div class="rounded-xl bg-white p-3 shadow-sm border border-sky-200">
      <div class="text-xs text-gray-500">Reserved</div>
      <div class="mt-1 flex items-end justify-between">
        <div class="text-2xl font-extrabold text-gray-900">
          {{ type_counts.reserved|default:0|intcomma }}
        </div>
        <span class="text-[10px] px-2 py-0.5 rounded-full bg-sky-100 text-sky-700">
          lots
        </span>
      </div>
    </div>

    <!-- Extra -->
    <div class="rounded-xl bg-white p-3 shadow-sm border border-orange-200">
      <div class="text-xs text-gray-500">Extra</div>
      <div class="mt-1 flex items-end justify-between">
        <div class="text-2xl font-extrabold text-gray-900">
          {{ type_counts.extra|default:0|intcomma }}
        </div>
        <span class="text-[10px] px-2 py-0.5 rounded-full bg-orange-100 text-orange-700">
          lots
        </span>
      </div>
    </div>

    <!-- Claim -->
    <div class="rounded-xl bg-white p-3 shadow-sm border border-rose-200">
      <div class="text-xs text-gray-500">Claim</div>
      <div class="mt-1 flex items-end justify-between">
        <div class="text-2xl font-extrabold text-gray-900">
          {{ type_counts.claim|default:0|intcomma }}
        </div>
        <span class="text-[10px] px-2 py-0.5 rounded-full bg-rose-100 text-rose-700">
          lots
        </span>
      </div>
    </div>
  </div>

  <!-- แสดงการ์ดแบ่งตามประเภท -->
  <div class="space-y-8">

    {% if grouped_lots.Order %}
    <section>
      <h2 class="text-lg font-semibold text-gray-800 mb-3">Order</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        {% for lot in grouped_lots.Order %}
        <div class="bg-white rounded-xl shadow-sm border border-purple-100 overflow-hidden">

          <!-- Header การ์ด + แว่น -->
          <div class="px-4 pt-4 pb-3 flex justify-between items-start">
            <div>
              <p class="font-bold text-lg text-gray-900">{{ lot.lot_no }}</p>
              <p class="text-xs text-gray-500 mt-1">
                Part: <b>{{ lot.part_no }}</b> · Customer: <b>{{ lot.customer }}</b>
              </p>
            </div>

            <div class="flex items-start gap-2">
              <!-- ไอคอนแว่น: ไปหน้า machine_detail -->
              <a href="{% url 'machine_detail' lot.machine_no %}?department={{ department }}"
                onclick="return confirm('ต้องการดูรายละเอียดงานของเครื่อง {{ lot.machine_no }} ใช่หรือไม่?');"
                class="mt-1 text-gray-400 hover:text-purple-600 transition"
                title="ดูรายละเอียดเครื่อง {{ lot.machine_no }}">
                <span class="material-symbols-outlined text-base">search</span>
              </a>

              <div class="text-right text-xs">
                <div class="inline-flex items-center px-2 py-0.5 rounded-full bg-purple-50 text-purple-700 font-semibold mb-1">
                  {{ lot.type }}
                </div>
                <div class="text-[11px] text-gray-400 font-mono">
                  {{ lot.produced|intcomma }} / {{ lot.target|intcomma }}
                </div>
              </div>
            </div>
          </div>

          <!-- Progress + summary -->
          <div class="px-4 pb-3">
            <div class="w-full bg-gray-100 rounded-full h-4 overflow-hidden mb-2">
              <div class="h-4 rounded-full text-[10px] text-white font-bold flex items-center justify-center"
                  style="width: {{ lot.progress }}%; background: hsl({{ lot.progress }},85%,45%);">
                {{ lot.progress }}%
              </div>
            </div>
            <div class="flex justify-between text-xs text-gray-600">
              <span>เป้า: <b>{{ lot.target|intcomma }}</b></span>
              <span>ผลิตแล้ว: <b>{{ lot.produced|intcomma }} pcs</b></span>
            </div>
          </div>

          <div class="px-4 py-2 bg-gray-50 text-[11px] text-gray-400 border-t">
            <p>สแกนครั้งแรก: {{ lot.first_scan|default:"-" }}</p>
            <p>สแกนล่าสุด: {{ lot.last_scan|default:"-" }}</p>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    {% if grouped_lots.Sample %}
    <section>
      <h2 class="text-lg font-semibold text-gray-800 mb-3">Sample</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        {% for lot in grouped_lots.Sample %}
        <!-- สามารถ copy การ์ดด้านบนมาใช้เหมือนกันได้ ถ้าอยากให้ Sample มีแว่นด้วย -->
        {% endfor %}
      </div>
    </section>
    {% endif %}

    {# ทำเหมือนกันสำหรับ Reserved / Extra / Claim ถ้ามีข้อมูล #}

  </div>

</div>
{% endblock %}
