{% extends "production/base.html" %}
{% load humanize %}

{% block title %}Lot {{ lot.lot_no }} · {{ department_label }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-6">

  <!-- breadcrumb -->
  <div class="flex items-center justify-between mb-6">
    <div class="text-sm text-gray-500 flex items-center gap-2">
      <a href="{% url 'home_menu' %}" class="hover:text-purple-600">Home</a>
      <span>/</span>
      <a href="{% url 'dashboard' %}?department={{ department }}&view=list"
         class="hover:text-purple-600">
        Dashboard: {{ department_label }}
      </a>
      <span>/</span>
      <span class="font-semibold text-gray-800">Lot {{ lot.lot_no }}</span>
    </div>

    <a href="{% url 'dashboard' %}?department={{ department }}&view=list"
       class="px-4 py-2 rounded-full bg-white text-sm border border-purple-300 shadow-sm hover:bg-purple-50">
      ← กลับไป List View
    </a>
  </div>

  <!-- หัวข้อหลัก -->
  <div class="bg-white rounded-2xl shadow-sm border border-purple-200/70 p-5 mb-6">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h1 class="text-2xl font-extrabold text-gray-900 mb-1">
          Lot {{ lot.lot_no }}
        </h1>
        <p class="text-sm text-gray-600">
          Part No: <span class="font-semibold">{{ lot.part_no|default:"-" }}</span>
          · Customer: <span class="font-semibold">{{ lot.customer|default:"-" }}</span>
        </p>
        <p class="text-xs text-gray-500 mt-1">
          Department: {{ lot.department|default:"-" }} · Machine: {{ lot.machine_no|default:"-" }}
        </p>
      </div>

      <div class="text-right">
        <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold
          {% if lot.type|lower == 'order' %}bg-green-50 text-green-700 border border-green-200
          {% elif lot.type|lower == 'sample' %}bg-yellow-50 text-yellow-700 border border-yellow-200
          {% elif lot.type|lower == 'reserved' %}bg-blue-50 text-blue-700 border border-blue-200
          {% elif lot.type|lower == 'extra' %}bg-orange-50 text-orange-700 border border-orange-200
          {% elif lot.type|lower == 'claim' %}bg-rose-50 text-rose-700 border border-rose-200
          {% else %}bg-gray-50 text-gray-700 border border-gray-200{% endif %}">
          {{ lot.type|default:"Order" }}
        </span>

        <p class="text-xs text-gray-400 mt-2">
          เป้า: {{ target|default:0|intcomma }} pcs<br>
          ผลิตแล้ว: {{ produced|default:0|intcomma }} pcs
        </p>
      </div>
    </div>

    <!-- progress bar -->
    <div class="mt-4">
      <div class="w-full h-4 rounded-full bg-gray-200 overflow-hidden">
        <div class="h-4 rounded-full bg-lime-400"
             style="width: {{ progress }}%;"></div>
      </div>
      <div class="flex justify-between text-xs text-gray-500 mt-1.5">
        <span>ความคืบหน้า: <span class="font-semibold">{{ progress }}%</span></span>
        <span>ประมาณจำนวนกล่อง: <span class="font-semibold">{{ boxes|intcomma }}</span></span>
      </div>
    </div>

    <!-- first / last scan -->
    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-gray-500">
      <div>
        <span class="block text-gray-400">สแกนครั้งแรก</span>
        <span class="font-semibold">
          {% if lot.first_scan %}{{ lot.first_scan|date:"d/m/Y H:i:s" }}{% else %}-{% endif %}
        </span>
      </div>
      <div>
        <span class="block text-gray-400">สแกนล่าสุด</span>
        <span class="font-semibold">
          {% if lot.last_scan %}{{ lot.last_scan|date:"d/m/Y H:i:s" }}{% else %}-{% endif %}
        </span>
      </div>
    </div>
  </div>

  <!-- กราฟปริมาณการสแกนต่อวัน (Line Chart) -->
  <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-5 mb-6">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold text-gray-800">กราฟปริมาณการสแกนต่อวัน</h2>
      <span class="text-xs text-gray-400">
        (เส้นน้ำเงิน = ต่อวัน, เส้นแดง = สะสม)
      </span>
    </div>

    {% if chart_labels and chart_daily %}
      <div class="w-full h-72">
        <canvas id="lotScanChart"></canvas>
      </div>
    {% else %}
      <p class="text-sm text-gray-400 text-center py-6">
        ยังไม่มีข้อมูลการสแกนเพียงพอสำหรับแสดงกราฟ
      </p>
    {% endif %}
  </div>

  <!-- Log การสแกน -->
  <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-5">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold text-gray-800">ประวัติการสแกน</h2>
      <span class="text-xs text-gray-400">
        ทั้งหมด {{ scan_logs|length }} รายการ
      </span>
    </div>

    {% if scan_logs %}
      <div class="overflow-x-auto">
        <table class="min-w-full text-xs border-t border-gray-100">
          <thead class="bg-gray-50 text-gray-500">
            <tr>
              <th class="px-3 py-2 text-left font-medium">เวลา</th>
              <th class="px-3 py-2 text-left font-medium">เครื่อง</th>
              <th class="px-3 py-2 text-right font-medium">จำนวน (pcs)</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            {% for s in scan_logs %}
            <tr class="hover:bg-gray-50">
              <td class="px-3 py-2">
                {{ s.scanned_at|date:"d/m/Y H:i:s" }}
              </td>
              <td class="px-3 py-2">
                {{ s.machine_no|default:"-" }}
              </td>
              <td class="px-3 py-2 text-right">
                {{ s.qty|intcomma }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-sm text-gray-400">ยังไม่มีข้อมูลการสแกนสำหรับ Lot นี้</p>
    {% endif %}
  </div>

</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
(function() {
  const labels = {{ chart_labels|default:"[]"|safe }};
  const daily = {{ chart_daily|default:"[]"|safe }};
  const cumsum = {{ chart_cumsum|default:"[]"|safe }};

  if (!labels.length) return;

  const ctx = document.getElementById("lotScanChart").getContext("2d");

  new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        {
          label: "ปริมาณต่อวัน (pcs)",
          data: daily,
          borderColor: "rgba(54, 162, 235, 1)",
          backgroundColor: "rgba(54, 162, 235, 0.2)",
          tension: 0.35,
          borderWidth: 3,
          pointRadius: 4,
          pointBackgroundColor: "rgba(54, 162, 235, 1)",
          fill: true,
          yAxisID: "y",
        },
        {
          label: "สะสม (pcs)",
          data: cumsum,
          borderColor: "rgba(255, 99, 132, 1)",
          backgroundColor: "rgba(255, 99, 132, 0.15)",
          tension: 0.25,
          borderWidth: 2.5,
          pointRadius: 3,
          pointBackgroundColor: "rgba(255, 99, 132, 1)",
          fill: false,
          yAxisID: "y1",
        }
      ]
    },

    options: {
      responsive: true,
      maintainAspectRatio: false,

      interaction: {
        mode: "index",
        intersect: false,
      },

      scales: {
        y: {
          position: "left",
          beginAtZero: true,
          grid: {
            color: "rgba(200, 200, 200, 0.3)",
          },
          ticks: {
            callback: function(value) {
              return value.toLocaleString();
            }
          }
        },
        y1: {
          position: "right",
          beginAtZero: true,
          grid: { drawOnChartArea: false },
          ticks: {
            callback: function(value) {
              return value.toLocaleString();
            }
          }
        }
      },

      plugins: {
        legend: {
          labels: {
            boxWidth: 12,
            boxHeight: 12,
            usePointStyle: true,
          }
        },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              return ctx.dataset.label + ": " + ctx.raw.toLocaleString() + " pcs";
            }
          }
        }
      }
    }
  });
})();
</script>
{% endblock %}
