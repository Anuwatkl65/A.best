{% extends "production/base.html" %}
{% load humanize %}
{% block title %}Lot {{ lot.lot_no }} · {{ department_label }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">

  <!-- breadcrumb + back -->
  <div class="flex items-center justify-between mb-6">
    <div class="text-sm text-gray-500 flex items-center gap-2">
      <a href="{% url 'home_menu' %}" class="hover:text-purple-600">Home</a>
      <span>/</span>
      <a href="{% url 'dashboard' %}?department={{ department }}&view=list"
         class="hover:text-purple-600">Dashboard: {{ department_label }}</a>
      <span>/</span>
      <span class="font-semibold text-gray-800">Lot {{ lot.lot_no }}</span>
    </div>

    <a href="{% url 'dashboard' %}?department={{ department }}&view=list"
       class="px-4 py-2 rounded-full bg-white text-sm text-gray-700 border border-purple-300 hover:bg-purple-50 shadow-sm">
      ← กลับไป List View
    </a>
  </div>

  <!-- หัวข้อ -->
  <div class="mb-4">
    <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900">
      Lot {{ lot.lot_no }}
    </h1>
    <p class="text-sm text-gray-500">
      Dashboard: {{ department_label }} · รายละเอียด Lot
    </p>
  </div>

  <!-- การ์ดหลัก -->
  <div class="bg-white rounded-2xl shadow-md border border-purple-200/70 mb-6 overflow-hidden">
    <div class="px-5 pt-4 pb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <p class="text-sm text-gray-500">Part No : <span class="font-semibold text-gray-800">{{ lot.part_no }}</span></p>
        <p class="text-sm text-gray-500">Customer : <span class="font-semibold text-gray-800">{{ lot.customer }}</span></p>
        <p class="text-xs text-gray-400 mt-1">
          Department : {{ lot.department }} | Machine : {{ lot.machine_no }}
        </p>
      </div>
      <div class="text-right">
        <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold
          {% if lot.type|lower == 'order' %}bg-green-50 text-green-700 border border-green-200
          {% elif lot.type|lower == 'sample' %}bg-yellow-50 text-yellow-700 border border-yellow-200
          {% elif lot.type|lower == 'reserved' %}bg-blue-50 text-blue-700 border border-blue-200
          {% elif lot.type|lower == 'extra' %}bg-orange-50 text-orange-700 border border-orange-200
          {% elif lot.type|lower == 'claim' %}bg-rose-50 text-rose-700 border border-rose-200
          {% else %}bg-gray-50 text-gray-700 border border-gray-200{% endif %}">
          {{ lot.type|default:"-" }}
        </span>
        <p class="text-xs text-gray-400 mt-1">
          เป้าการผลิต : {{ target|intcomma }} pcs
        </p>
        <p class="text-xs text-gray-400">
          ผลิตแล้ว : {{ produced|intcomma }} pcs ({{ progress }}%)
        </p>
      </div>
    </div>

    <!-- Progress bar -->
    <div class="px-5 pb-4">
      <div class="w-full h-5 rounded-full bg-gray-200 overflow-hidden">
        <div class="h-5 rounded-full bg-emerald-400 text-[11px] text-white font-semibold flex items-center justify-center"
             style="width: {{ progress }}%;">
          {{ progress }}%
        </div>
      </div>
      <div class="flex justify-between text-xs text-gray-500 mt-2">
        <span>จำนวนบรรจุต่อกล่อง : {{ boxes }}</span>
        <span>เป้าการผลิตรวม : {{ target|intcomma }} pcs</span>
      </div>
    </div>

    <div class="px-5 pt-3 pb-4 border-t border-gray-100 text-xs text-gray-500">
      <p>สแกนครั้งแรก : {% if lot.first_scan %}{{ lot.first_scan|date:"d/m/Y H:i:s" }}{% else %}-{% endif %}</p>
      <p>สแกนล่าสุด : {% if lot.last_scan %}{{ lot.last_scan|date:"d/m/Y H:i:s" }}{% else %}-{% endif %}</p>
    </div>
  </div>

  <!-- พื้นที่กราฟ (เผื่อทำต่อด้วย JS/Chart) -->
  <div class="bg-white rounded-2xl shadow-sm border border-gray-200 mb-6">
    <div class="px-5 py-3 border-b border-gray-100 flex items-center justify-between">
      <p class="text-sm font-semibold text-gray-800">กราฟปริมาณการสแกนต่อวัน</p>
      <p class="text-xs text-gray-400">(สำหรับ v2: สามารถใส่ JS chart เช่น Chart.js ทีหลังได้)</p>
    </div>
    <div class="px-5 py-6 text-center text-gray-400 text-sm" id="lot-chart-placeholder">
      ยังไม่ได้เชื่อมกราฟในระบบ Django — ใช้เป็น placeholder ไว้ก่อน
    </div>
  </div>

  <!-- ตาราง Scan Log -->
  <div class="bg-white rounded-2xl shadow-sm border border-gray-200">
    <div class="px-5 py-3 border-b border-gray-100 flex items-center justify-between">
      <p class="text-sm font-semibold text-gray-800">ประวัติการสแกน</p>
      <p class="text-xs text-gray-400">{{ scan_logs|length }} rows</p>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full text-xs">
        <thead class="bg-gray-50 text-gray-500">
          <tr>
            <th class="px-4 py-2 text-left">วันที่สแกน</th>
            <th class="px-4 py-2 text-left">เวลา</th>
            <th class="px-4 py-2 text-left">เครื่อง</th>
            <th class="px-4 py-2 text-right">จำนวน (pcs)</th>
          </tr>
        </thead>
        <tbody>
          {% for s in scan_logs %}
          <tr class="border-t border-gray-100">
            <td class="px-4 py-2">{{ s.scanned_at|date:"d/m/Y" }}</td>
            <td class="px-4 py-2">{{ s.scanned_at|date:"H:i:s" }}</td>
            <td class="px-4 py-2">{{ s.machine_no }}</td>
            <td class="px-4 py-2 text-right">{{ s.qty|intcomma }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4" class="px-4 py-4 text-center text-gray-400">
              ยังไม่มีประวัติการสแกนสำหรับ Lot นี้
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}
