  {% extends "production/base.html" %}
  {% load humanize %}

  {% block title %}Lot {{ lot.lot_no }} ¬∑ {{ department_label }}{% endblock %}

  {% block content %}
  <div class="max-w-5xl mx-auto px-4 py-6">

    <!-- breadcrumb + ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏â‡∏•‡∏≤‡∏î (‡∏à‡∏≥ view ‡πÄ‡∏î‡∏¥‡∏°) -->
    <div class="flex items-center justify-between mb-6">
      <div class="text-sm text-gray-500 flex items-center gap-2">
        <a href="{% url 'home_menu' %}" class="hover:text-purple-600">Home</a>
        <span>/</span>
        <a href="{% url 'dashboard' %}?department={{ department }}&view={{ back_view|default:'list' }}"
          class="hover:text-purple-600">
          Dashboard: {{ department_label }}
        </a>
        <span>/</span>
        <span class="font-semibold text-gray-800">Lot {{ lot.lot_no }}</span>
      </div>

  <a href="{{ back_url }}"
    class="px-4 py-2 rounded-full bg-white text-sm border border-purple-300 shadow-sm hover:bg-purple-50 flex items-center gap-1">
    <span class="material-symbols-outlined text-[18px]">arrow_back</span>
    {{ back_label }}
  </a>

    </div>


    <!-- ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å -->
    <div class="bg-white rounded-2xl shadow-sm border border-purple-200/70 p-5 mb-6">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h1 class="text-2xl font-extrabold text-gray-900 mb-1">
            Lot {{ lot.lot_no }}
          </h1>
          <p class="text-sm text-gray-600">
            Part No: <span class="font-semibold">{{ lot.part_no|default:"-" }}</span>
            ¬∑ Customer: <span class="font-semibold">{{ lot.customer|default:"-" }}</span>
          </p>
          <p class="text-xs text-gray-500 mt-1">
            Department: {{ lot.department|default:"-" }} ¬∑ Machine: {{ lot.machine_no|default:"-" }}
          </p>
        </div>

        <div class="text-right">
          <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold
            {% if lot.type|lower == 'order' %}bg-green-50 text-green-700 border border-green-200
            {% elif lot.type|lower == 'sample' %}bg-yellow-50 text-yellow-700 border border-yellow-200
            {% elif lot.type|lower == 'reserved' %}bg-blue-50 text-blue-700 border border-blue-200
            {% elif lot.type|lower == 'extra' %}bg-orange-50 text-orange-700 border border-orange-200
            {% elif lot.type|lower == 'claim' %}bg-rose-50 text-rose-700 border border-rose-200
            {% else %}bg-gray-50 text-gray-700 border border-gray-200{% endif %}">
            {{ lot.type|default:"Order" }}
          </span>

          <p class="text-xs text-gray-400 mt-2">
            ‡πÄ‡∏õ‡πâ‡∏≤: {{ target|default:0|intcomma }} pcs<br>
            ‡∏ú‡∏•‡∏¥‡∏ï‡πÅ‡∏•‡πâ‡∏ß: {{ produced|default:0|intcomma }} pcs
          </p>
        </div>
      </div>

      <!-- progress bar -->
      <div class="mt-4">
        <div class="w-full h-4 rounded-full bg-gray-200 overflow-hidden">
          <div class="h-4 rounded-full bg-lime-400"
              style="width: {{ progress }}%;"></div>
        </div>
        <div class="flex justify-between text-xs text-gray-500 mt-1.5">
          <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤: <span class="font-semibold">{{ progress }}%</span></span>
          <span>‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á: <span class="font-semibold">{{ boxes|intcomma }}</span></span>
        </div>
      </div>

      <!-- first / last scan -->
      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-gray-500">
        <div>
          <span class="block text-gray-400">‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å</span>
          <span class="font-semibold">
            {% if lot.first_scan %}{{ lot.first_scan|date:"d/m/Y H:i:s" }}{% else %}-{% endif %}
          </span>
        </div>
        <div>
          <span class="block text-gray-400">‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
          <span class="font-semibold">
            {% if lot.last_scan %}{{ lot.last_scan|date:"d/m/Y H:i:s" }}{% else %}-{% endif %}
          </span>
        </div>
      </div>
    </div>

    <!-- ‡∏Å‡∏£‡∏≤‡∏ü‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô -->
    <!-- ‡∏Å‡∏£‡∏≤‡∏ü‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-5 mb-6">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h2 class="text-lg font-semibold text-gray-800">
            ‡∏Å‡∏£‡∏≤‡∏ü‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô
            {% if agg == "hour" %}<span class="text-sm text-gray-500">(‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)</span>{% endif %}
            {% if agg == "day" %}<span class="text-sm text-gray-500">(‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)</span>{% endif %}
            {% if agg == "month" %}<span class="text-sm text-gray-500">(‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</span>{% endif %}
          </h2>
          <span class="text-xs text-gray-400">
            (‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô = ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ï‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤, ‡∏ä‡∏°‡∏û‡∏π = ‡∏™‡∏∞‡∏™‡∏°)
          </span>
        </div>

        <!-- dropdown ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏Å‡∏£‡∏≤‡∏ü -->
          <input type="hidden" name="department" value="{{ department }}">

          <label for="agg" class="text-gray-500">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á:</label>
          <select id="agg" name="agg"
                  class="border border-gray-300 rounded-full px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-purple-500"
                  onchange="this.form.submit()">
            <option value="hour" {% if agg == "hour" %}selected{% endif %}>‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
            <option value="day" {% if agg == "day" %}selected{% endif %}>‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
            <option value="month" {% if agg == "month" %}selected{% endif %}>‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
          </select>
      </div>

      {% if chart_labels and chart_daily %}
        <div class="w-full h-72">
          <canvas id="lotScanChart"></canvas>
        </div>
      {% else %}
        <p class="text-sm text-gray-400 text-center py-6">
          ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü
        </p>
      {% endif %}
    </div>


    <!-- Log ‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô + Filter / Sort -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-5">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
        <div>
          <h2 class="text-lg font-semibold text-gray-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô</h2>
          <span class="text-xs text-gray-400">
            ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î {{ scan_logs|length }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
          </span>
        </div>

  <!-- Log ‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô + Filter / Sort -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-5">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
        <div>
          <h2 class="text-lg font-semibold text-gray-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô</h2>
          <span id="scan-count" class="text-xs text-gray-400">
            ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î {{ scan_logs|length }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
          </span>
        </div>

        <!-- üî• ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å form ‡πÄ‡∏õ‡πá‡∏ô div ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ -->
        <div class="flex flex-wrap items-center gap-2 text-xs md:justify-end" id="scan-filter-bar">
          <!-- sort -->
          <label for="scan_order" class="text-gray-500">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°:</label>
          <select id="scan_order"
                  class="border border-gray-300 rounded-full px-2.5 py-1.5 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <option value="newest" {% if scan_order == 'newest' %}selected{% endif %}>‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô</option>
            <option value="oldest" {% if scan_order == 'oldest' %}selected{% endif %}>‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô</option>
            <option value="qty_desc" {% if scan_order == 'qty_desc' %}selected{% endif %}>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏°‡∏≤‡∏Å ‚Üí ‡∏ô‡πâ‡∏≠‡∏¢</option>
            <option value="qty_asc" {% if scan_order == 'qty_asc' %}selected{% endif %}>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≠‡∏¢ ‚Üí ‡∏°‡∏≤‡∏Å</option>
          </select>

          <!-- filter machine -->
          <label for="scan_machine" class="text-gray-500">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á:</label>
          <select id="scan_machine"
                  class="border border-gray-300 rounded-full px-2.5 py-1.5 focus:outline-none focus:ring-2 focus:ring-purple-500">
            <option value="all" {% if scan_machine == 'all' %}selected{% endif %}>‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</option>
            {% for m in scan_machines %}
              <option value="{{ m }}" {% if scan_machine == m %}selected{% endif %}>{{ m }}</option>
            {% endfor %}
          </select>

          <!-- filter date range -->
          <label for="scan_from" class="text-gray-500">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà:</label>
          <input type="date" id="scan_from"
                value="{{ scan_from }}"
                class="border border-gray-300 rounded-full px-2 py-1 focus:outline-none focus:ring-2 focus:ring-purple-500">

          <label for="scan_to" class="text-gray-500">‡∏ñ‡∏∂‡∏á:</label>
          <input type="date" id="scan_to"
                value="{{ scan_to }}"
                class="border border-gray-300 rounded-full px-2 py-1 focus:outline-none focus:ring-2 focus:ring-purple-500">

          <button type="button" id="scan-filter-btn"
                  class="px-3 py-1.5 rounded-full bg-purple-600 text-white font-medium hover:bg-purple-700">
            ‡∏Å‡∏£‡∏≠‡∏á
          </button>

          <button type="button" id="scan-clear-btn"
                  class="px-3 py-1.5 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200">
            ‡∏•‡πâ‡∏≤‡∏á
          </button>
        </div>
      </div>

      {% if scan_logs %}
        <div class="overflow-x-auto">
          <table class="min-w-full text-xs border-t border-gray-100">
            <thead class="bg-gray-50 text-gray-500">
              <tr>
                <th class="px-3 py-2 text-left font-medium">‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th class="px-3 py-2 text-left font-medium">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
                <th class="px-3 py-2 text-right font-medium">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (pcs)</th>
              </tr>
            </thead>
            <tbody id="scan-logs-body" class="divide-y divide-gray-100">
              {% for s in scan_logs %}
                <tr class="hover:bg-gray-50"
                    data-ts="{{ s.scanned_at|date:'c' }}"
                    data-machine="{{ s.machine_no|default_if_none:'' }}"
                    data-qty="{{ s.qty }}">
                  <td class="px-3 py-2">
                    {{ s.scanned_at|date:"d/m/Y H:i:s" }}
                  </td>
                  <td class="px-3 py-2">
                    {{ s.machine_no|default:"-" }}
                  </td>
                  <td class="px-3 py-2 text-right">
                    {{ s.qty|intcomma }}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-sm text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Lot ‡∏ô‡∏µ‡πâ</p>
      {% endif %}

  </div>
  {% endblock %}

  {% block extra_js %}
  {{ block.super }}

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
  (function () {
    const canvas = document.getElementById("lotScanChart");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");

    let chart = null;

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å backend ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü
    async function loadChart(agg) {
      const department = "{{ department }}";
      const lotNo = "{{ lot.lot_no }}";

      const url = new URL(
        "{% url 'lot_chart_data' lot.lot_no %}",
        window.location.origin
      );
      url.searchParams.set("agg", agg);
      url.searchParams.set("department", department);

      const res = await fetch(url);
      const data = await res.json();

      const labels = data.labels || [];
      const daily = data.daily || [];
      const cumulative = data.cumulative || [];

      if (!labels.length) return;

      if (chart) {
        chart.destroy();
      }

      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [
            {
              type: "bar",
              label: "‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ï‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (pcs)",
              data: daily,
              backgroundColor: "rgba(59, 130, 246, 0.5)",
              borderColor: "rgba(59, 130, 246, 1)",
              borderWidth: 1,
              yAxisID: "y",
            },
            {
              type: "line",
              label: "‡∏™‡∏∞‡∏™‡∏° (pcs)",
              data: cumulative,
              borderColor: "rgba(236, 72, 153, 1)",
              backgroundColor: "rgba(236, 72, 153, 0.15)",
              borderWidth: 2,
              pointRadius: 3,
              pointBackgroundColor: "rgba(236, 72, 153, 1)",
              tension: 0.25,
              fill: false,
              yAxisID: "y1",
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          // üëá ‡∏Ñ‡∏•‡∏¥‡∏Å drill-down ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏£‡∏µ‡∏´‡∏ô‡πâ‡∏≤
          onClick: function (evt, elements) {
            if (!elements || !elements.length) return;

            let currentAgg = aggSelector.value || "hour";
            let nextAgg = null;

            if (currentAgg === "month") nextAgg = "day";
            else if (currentAgg === "day") nextAgg = "hour";
            else return;

            aggSelector.value = nextAgg;
            loadChart(nextAgg);
          },
          scales: {
            y: {
              position: "left",
              beginAtZero: true,
              grid: { color: "rgba(148, 163, 184, 0.3)" },
              ticks: {
                callback: (value) => {
                  try { return value.toLocaleString(); }
                  catch (e) { return value; }
                },
              },
            },
            y1: {
              position: "right",
              beginAtZero: true,
              grid: { drawOnChartArea: false },
              ticks: {
                callback: (value) => {
                  try { return value.toLocaleString(); }
                  catch (e) { return value; }
                },
              },
            },
            x: {
              ticks: { maxRotation: 45, minRotation: 0 },
            },
          },
          plugins: {
            legend: {
              labels: { usePointStyle: true, boxWidth: 10 },
            },
            tooltip: {
              callbacks: {
                label: function (ctx) {
                  const raw = ctx.raw;
                  const formatted =
                    raw && raw.toLocaleString ? raw.toLocaleString() : raw;
                  return ctx.dataset.label + ": " + formatted + " pcs";
                },
              },
            },
          },
        },
      });
    }

    // ‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö dropdown ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á
    const aggSelector = document.getElementById("agg");
    if (aggSelector) {
      aggSelector.addEventListener("change", function () {
        const agg = this.value || "hour";
        loadChart(agg);
      });
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤ agg ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const initialAgg = "{{ agg|default:'hour' }}";
    if (aggSelector) {
      aggSelector.value = initialAgg;
    }
    loadChart(initialAgg);
  })();
  </script>

  <script>
  (function () {
    const tbody = document.getElementById("scan-logs-body");
    if (!tbody) return;

    const rows = Array.from(tbody.querySelectorAll("tr"));
    const originalRows = rows.slice();  // ‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° "‡∏•‡πâ‡∏≤‡∏á"

    const orderSel   = document.getElementById("scan_order");
    const machineSel = document.getElementById("scan_machine");
    const fromInput  = document.getElementById("scan_from");
    const toInput    = document.getElementById("scan_to");
    const filterBtn  = document.getElementById("scan-filter-btn");
    const clearBtn   = document.getElementById("scan-clear-btn");
    const countSpan  = document.getElementById("scan-count");

    function applyFilters() {
      let filtered = rows.slice();

      // 1) ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
      const machine = machineSel ? machineSel.value : "all";
      if (machine && machine !== "all") {
        filtered = filtered.filter(tr => (tr.dataset.machine || "") === machine);
      }

      // 2) ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
      const fromVal = fromInput && fromInput.value;
      const toVal   = toInput && toInput.value;

      if (fromVal) {
        const fromTime = new Date(fromVal + "T00:00:00").getTime();
        filtered = filtered.filter(tr => {
          const t = new Date(tr.dataset.ts).getTime();
          return t >= fromTime;
        });
      }
      if (toVal) {
        const toTime = new Date(toVal + "T23:59:59").getTime();
        filtered = filtered.filter(tr => {
          const t = new Date(tr.dataset.ts).getTime();
          return t <= toTime;
        });
      }

      // 3) ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
      const order = orderSel ? orderSel.value : "newest";
      filtered.sort((a, b) => {
        const ta = new Date(a.dataset.ts).getTime();
        const tb = new Date(b.dataset.ts).getTime();
        const qa = parseFloat(a.dataset.qty || "0");
        const qb = parseFloat(b.dataset.qty || "0");

        if (order === "oldest") {
          return ta - tb;              // ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô
        }
        if (order === "qty_desc") {
          if (qb !== qa) return qb - qa; // ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏°‡∏≤‡∏Å ‚Üí ‡∏ô‡πâ‡∏≠‡∏¢
          return tb - ta;
        }
        if (order === "qty_asc") {
          if (qa !== qb) return qa - qb; // ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≠‡∏¢ ‚Üí ‡∏°‡∏≤‡∏Å
          return ta - tb;
        }
        // default: newest
        return tb - ta;                // ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô
      });

      // 4) ‡πÉ‡∏™‡πà‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ tbody
      tbody.innerHTML = "";
      filtered.forEach(tr => tbody.appendChild(tr));

      if (countSpan) {
        countSpan.textContent = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${filtered.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
      }
    }

    function clearFilters() {
      if (orderSel)   orderSel.value = "newest";
      if (machineSel) machineSel.value = "all";
      if (fromInput)  fromInput.value = "";
      if (toInput)    toInput.value = "";

      tbody.innerHTML = "";
      originalRows.forEach(tr => tbody.appendChild(tr));

      if (countSpan) {
        countSpan.textContent = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${originalRows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
      }
    }

    if (filterBtn) filterBtn.addEventListener("click", applyFilters);
    if (clearBtn)  clearBtn.addEventListener("click", clearFilters);

    // ‡πÉ‡∏ä‡πâ on-change ‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Å‡πá‡πÑ‡∏î‡πâ
    if (orderSel)   orderSel.addEventListener("change", applyFilters);
    if (machineSel) machineSel.addEventListener("change", applyFilters);
  })();
  </script>

  {% endblock %}
