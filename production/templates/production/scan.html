{% extends "production/base.html" %}
{% block title %}Scan Barcode · Production Tracker{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-6">

  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
    <div>
      <h2 class="text-2xl font-bold text-gray-800">Scan Barcode</h2>
      <p class="text-sm text-gray-500">ส่องกล้องที่ QR/Barcode หรือเลือกไฟล์รูปเพื่อบันทึกข้อมูล</p>
    </div>
    <a href="{% url 'home_menu' %}"
       class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-full text-sm font-semibold text-gray-600 hover:bg-purple-50 hover:text-purple-700 transition-all shadow-sm">
      <span class="material-symbols-outlined text-[20px]">arrow_back</span>
      กลับหน้าหลัก
    </a>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- กล้อง + สแกนจากไฟล์ -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden flex flex-col">
      <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
        <h3 class="font-semibold text-gray-700 flex items-center gap-2">
          <span class="material-symbols-outlined text-purple-600">videocam</span> กล้องสแกน
        </h3>
        <span id="camera-status"
              class="text-xs px-2 py-1 rounded bg-gray-200 text-gray-600">
          Standby
        </span>
      </div>

      <div class="relative bg-black min-h-[300px] flex items-center justify-center">
        <div id="reader" class="w-full h-full"></div>

        <!-- overlay ข้อความ -->
        <div id="camera-placeholder"
             class="absolute inset-0 flex flex-col items-center justify-center text-gray-300 text-sm">
          <span class="material-symbols-outlined text-6xl mb-2 opacity-50">
            qr_code_scanner
          </span>
          <p id="camera-message">กำลังเตรียมกล้อง...</p>
        </div>
      </div>

      <!-- ปุ่มควบคุมกล้อง + อัปโหลดไฟล์ -->
      <div class="p-4 flex flex-col sm:flex-row items-center justify-center gap-3">
        <button id="toggle-camera-btn"
                class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm font-semibold hover:bg-purple-200 transition-colors">
          ปิด/เปิด กล้อง
        </button>

        <button id="upload-file-btn"
                class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg text-sm font-semibold hover:bg-purple-50 hover:border-purple-400 transition-colors flex items-center gap-2">
          <span class="material-symbols-outlined text-[18px]">image</span>
          เลือกไฟล์รูป QR
        </button>

        <!-- input ไฟล์ (ซ่อน) -->
        <input id="qr-file-input" type="file" accept="image/*" class="hidden">
      </div>
    </div>

    <!-- ฝั่งกรอกข้อมูลเอง -->
    <div class="space-y-6">
      <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
        <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
          <span class="material-symbols-outlined text-blue-600">keyboard</span> กรอกข้อมูลเอง
        </h3>

        <div class="space-y-4">
          <!-- LOT NO + ปุ่มเคลียร์ -->
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1">LOT NO.</label>
            <div class="relative">
              <input type="text" id="lot-input"
                     placeholder="สแกนหรือพิมพ์ Lot No."
                     class="w-full px-4 py-3 pr-10 border border-gray-300 rounded-xl text-lg font-bold text-gray-800 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition-all"
                     autofocus>
              <button type="button" id="lot-clear-btn"
                      class="absolute right-3 top-1/2 -translate-y-1/2 w-6 h-6 rounded-full bg-purple-50 text-purple-500 flex items-center justify-center hover:bg-purple-100 hover:text-purple-700">
                <span class="material-symbols-outlined text-[18px]">close</span>
              </button>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1">จำนวน (Qty)</label>
              <input type="number" id="qty-input" value="1" min="1"
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg text-center font-semibold focus:ring-2 focus:ring-purple-500 outline-none">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1">เครื่อง (Machine)</label>
              <input type="text" id="machine-input" value="MC-01"
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg text-center font-semibold focus:ring-2 focus:ring-purple-500 outline-none">
            </div>
          </div>

          <button id="submit-btn"
                  class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-bold text-lg shadow-md transition-all active:scale-95 flex justify-center items-center gap-2">
            <span class="material-symbols-outlined">save</span>
            บันทึกข้อมูล
          </button>
        </div>
      </div>

      <!-- history -->
      <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
        <h3 class="font-semibold text-gray-800 mb-3 text-sm">ประวัติการสแกนล่าสุด</h3>
        <ul id="scan-history" class="space-y-2 text-sm">
          <li class="text-center text-gray-400 py-4 text-xs">ยังไม่มีรายการสแกน</li>
        </ul>
      </div>
    </div>
  </div>

</div>

<audio id="beep-sound" src="https://www.soundjay.com/button/beep-07.wav"></audio>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
  const SCRIPT_URL   = "/api/";
  const beepSound    = document.getElementById("beep-sound");
  const lotInput     = document.getElementById("lot-input");
  const qtyInput     = document.getElementById("qty-input");
  const machineInput = document.getElementById("machine-input");
  const submitBtn    = document.getElementById("submit-btn");
  const historyList  = document.getElementById("scan-history");
  const cameraStatus = document.getElementById("camera-status");
  const placeholder  = document.getElementById("camera-placeholder");
  const cameraMsg    = document.getElementById("camera-message");
  const clearBtn     = document.getElementById("lot-clear-btn");

  const uploadBtn    = document.getElementById("upload-file-btn");
  const fileInput    = document.getElementById("qr-file-input");

  // ---- ปุ่มเคลียร์ LOT ----
  clearBtn.addEventListener("click", () => {
    lotInput.value = "";
    lotInput.focus();
  });

  // ---- จัดการกล้องด้วย Html5Qrcode ----
  let html5QrCode = null;
  let isCameraRunning = false;

  function setCameraStatus(text, cls) {
    cameraStatus.innerText = text;
    cameraStatus.className =
      "text-xs px-2 py-1 rounded " + cls;
  }

  function onScanSuccess(decodedText /*, decodedResult */) {
    if (lotInput.value !== decodedText) {
      beepSound.play().catch(() => {});
      lotInput.value = decodedText;
      lotInput.classList.add("bg-green-50", "border-green-500");
      setTimeout(() => {
        lotInput.classList.remove("bg-green-50", "border-green-500");
      }, 500);
    }
  }

  function onScanFailure(error) {
    // console.debug(error); // ถ้าอยากดู log
  }

  function ensureInstance() {
    if (!html5QrCode) {
      html5QrCode = new Html5Qrcode("reader");
    }
  }

  function startCamera() {
    if (isCameraRunning) return;

    ensureInstance();
    cameraMsg.textContent = "กำลังค้นหากล้อง...";
    placeholder.style.display = "flex";

    Html5Qrcode.getCameras()
      .then(devices => {
        if (!devices || !devices.length) {
          cameraMsg.textContent = "ไม่พบอุปกรณ์กล้อง";
          setCameraStatus("No Camera", "bg-red-100 text-red-700");
          return;
        }

        const cameraId = devices[0].id;

        html5QrCode
          .start(
            cameraId,
            { fps: 10, qrbox: { width: 250, height: 250 } },
            onScanSuccess,
            onScanFailure
          )
          .then(() => {
            isCameraRunning = true;
            placeholder.style.display = "none";
            setCameraStatus("Active", "bg-green-100 text-green-700 font-bold");
          })
          .catch(err => {
            console.error("start camera error:", err);
            cameraMsg.textContent = "เปิดกล้องไม่สำเร็จ: " + err;
            placeholder.style.display = "flex";
            setCameraStatus("Error", "bg-red-100 text-red-700");
          });
      })
      .catch(err => {
        console.error("getCameras error:", err);
        cameraMsg.textContent = "ไม่สามารถเข้าถึงรายการกล้องได้";
        placeholder.style.display = "flex";
        setCameraStatus("Error", "bg-red-100 text-red-700");
      });
  }

  function stopCamera() {
    if (!html5QrCode || !isCameraRunning) return;

    html5QrCode.stop()
      .then(() => {
        isCameraRunning = false;
        placeholder.style.display = "flex";
        cameraMsg.textContent = "กล้องถูกปิดชั่วคราว";
        setCameraStatus("Paused", "bg-yellow-100 text-yellow-700");
      })
      .catch(err => {
        console.error("stop camera error:", err);
      });
  }

  document.getElementById("toggle-camera-btn").addEventListener("click", () => {
    if (isCameraRunning) {
      stopCamera();
    } else {
      startCamera();
    }
  });

  // ---- สแกนจากไฟล์รูป ----
  uploadBtn.addEventListener("click", () => {
    fileInput.click();
  });

  fileInput.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      ensureInstance();
      // ถ้ากล้องกำลังทำงานต้องหยุดก่อนถึงจะ scanFile ได้
      if (isCameraRunning) {
        await html5QrCode.stop();
        isCameraRunning = false;
        setCameraStatus("Paused", "bg-yellow-100 text-yellow-700");
      }

      placeholder.style.display = "flex";
      cameraMsg.textContent = "กำลังอ่านข้อมูลจากรูป...";

      const result = await html5QrCode.scanFile(file, true);
      // result คือ decodedText
      onScanSuccess(result, null);

      cameraMsg.textContent = "อ่านจากรูปสำเร็จ (สามารถเปิดกล้องต่อได้)";
    } catch (err) {
      console.error("scanFile error:", err);
      alert("อ่าน QR จากรูปไม่สำเร็จ กรุณาลองรูปอื่นอีกครั้ง");
      cameraMsg.textContent = "อ่านจากรูปไม่สำเร็จ";
    } finally {
      // เคลียร์ค่า file input เพื่อให้เลือกไฟล์เดิมซ้ำได้
      fileInput.value = "";
    }
  });

  // ---- ฟังก์ชันบันทึกข้อมูล ----
  async function submitData() {
    const lot = lotInput.value.trim();
    const qty = qtyInput.value;
    const mc  = machineInput.value;

    if (!lot) { alert("กรุณาระบุ Lot No."); return; }

    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML =
      '<span class="material-symbols-outlined animate-spin">refresh</span> บันทึก...';
    submitBtn.disabled = true;

    try {
      const res = await fetch(SCRIPT_URL, {
        method: "POST",
        body: new URLSearchParams({
          action: "scan",
          lot_no: lot,
          qty: qty,
          machine_no: mc
        })
      });
      const j = await res.json();

      if (j.status === "success") {
        addHistory(lot, qty, mc);
        lotInput.value = "";
        lotInput.focus();
      } else {
        alert("เกิดข้อผิดพลาด: " + (j.message || "Unknown error"));
      }
    } catch (e) {
      console.error(e);
      alert("เชื่อมต่อ Server ไม่ได้");
    } finally {
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }
  }

  function addHistory(lot, qty, mc) {
    if (historyList.children[0]?.innerText === "ยังไม่มีรายการสแกน") {
      historyList.innerHTML = "";
    }

    const li = document.createElement("li");
    li.className =
      "flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-100 animate-fade-in-down";
    li.innerHTML = `
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
          <span class="material-symbols-outlined text-sm">check</span>
        </div>
        <div>
          <div class="font-bold text-gray-800">${lot}</div>
          <div class="text-xs text-gray-500">MC: ${mc} | Qty: ${qty}</div>
        </div>
      </div>
      <span class="text-xs text-gray-400">
        ${new Date().toLocaleTimeString("th-TH", { hour: "2-digit", minute: "2-digit" })}
      </span>
    `;
    historyList.prepend(li);
  }

  submitBtn.addEventListener("click", submitData);

  // เริ่มเปิดกล้องอัตโนมัติเมื่อหน้าโหลดเสร็จ
  window.addEventListener("load", () => {
    startCamera();
  });
</script>

<style>
  #reader__scan_region img { max-width: 100%; }

  @keyframes fadeInDown {
    from { opacity: 0; transform: translateY(-10px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .animate-fade-in-down {
    animation: fadeInDown 0.3s ease-out forwards;
  }
</style>
{% endblock %}
