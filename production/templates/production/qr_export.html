{% extends "production/base.html" %}
{% block title %}QR Code Export{% endblock %}
{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
  
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
    <h2 class="text-2xl font-bold text-gray-800">QR Code Export</h2>
    <a href="{% url 'home_menu' %}" class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-full text-sm font-semibold text-gray-600 hover:bg-purple-50 hover:text-purple-700 transition-all shadow-sm">
      <span class="material-symbols-outlined text-[20px]">arrow_back</span>
      กลับหน้าหลัก
    </a>
  </div>

  <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 space-y-6">

    <!-- แถวกรอก Lot + ปุ่มสร้าง QR -->
    <div class="flex flex-col md:flex-row gap-3 items-start md:items-center">
      <div class="flex-grow w-full md:w-auto">
        <label class="block text-xs text-gray-500 mb-1 ml-1">ระบุ Lot No.</label>

        <!-- กล่อง input + ปุ่มเคลียร์ -->
        <div class="relative">
          <input
            id="qr-lot-no-input"
            list="qr-lot-no-list"
            placeholder="พิมพ์หรือเลือก Lot No."
            class="w-full px-4 py-2 border border-gray-300 rounded-lg pr-10
                   focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all"
          />
          <datalist id="qr-lot-no-list"></datalist>

          <!-- ปุ่มเคลียร์ช่อง Lot -->
          <button
            type="button"
            data-clear-target="qr-lot-no-input"
            class="absolute right-2 top-1/2 -translate-y-1/2
                   w-6 h-6 rounded-full bg-purple-50 text-purple-500 flex items-center justify-center
                   hover:bg-purple-100 hover:text-purple-700"
          >
            <span class="material-symbols-outlined text-[18px]">close</span>
          </button>
        </div>
      </div>

      <button id="export-qr-btn" class="mt-auto px-6 py-2.5 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition-colors shadow-sm flex items-center gap-2">
        <span class="material-symbols-outlined text-lg">qr_code_2</span>
        สร้าง QR
      </button>
    </div>
    
    <div class="flex justify-center p-8 bg-gray-50 rounded-lg border border-dashed border-gray-200">
      <canvas id="qr-canvas"></canvas>
    </div>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script>
  const SCRIPT_URL = "/api/";
  const input = document.getElementById('qr-lot-no-input');
  const list  = document.getElementById('qr-lot-no-list');

  async function loadLots() {
    try {
      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: new URLSearchParams({ action: 'getData' })
      });
      const j = await res.json();
      const rows = (j.data && j.data.dashboardData) || j.data || [];
      list.innerHTML = '';
      rows.forEach(x => {
        const opt = document.createElement('option');
        opt.value = x.lot_no || x.lotNo;
        if (opt.value) list.appendChild(opt);
      });
    } catch (e) {
      console.error(e);
    }
  }

  document.getElementById('export-qr-btn').onclick = () => {
    const lot = input.value.trim();
    if (!lot) {
      alert('กรุณาใส่ Lot No.');
      return;
    }
    new QRious({
      element: document.getElementById('qr-canvas'),
      value: lot,
      size: 200,
      level: 'H'
    });
  };

  // ปุ่มเคลียร์ช่อง Lot (ไม่รีหน้า)
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('button[data-clear-target]');
    if (!btn) return;

    e.preventDefault();

    const targetId = btn.getAttribute('data-clear-target');
    const targetInput = document.getElementById(targetId);
    if (targetInput) {
      targetInput.value = '';
    }
  });

  loadLots();
</script>
{% endblock %}
